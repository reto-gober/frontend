---
import BaseLayout from './BaseLayout.astro';

export interface Props {
  title: string;
}

const { title } = Astro.props;
const path = Astro.url.pathname || '/';
---

<BaseLayout title={title}>
  <div class="app-shell" data-route={path}>
    <aside class="sidebar" aria-label="Navegación principal">
      <div class="sidebar__header">
        <button id="sidebar-toggle" class="icon-btn icon-btn--bubble" aria-label="Contraer/expandir menú" aria-expanded="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 6l6 6-6 6"/></svg>
        </button>
      </div>

      <nav class="sidebar__nav">
        <a href="/dashboard" class={`nav-item ${path.startsWith('/dashboard') ? 'is-active' : ''}`} title="Dashboard" data-tip="Dashboard">
          <span class="nav-item__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="14" width="7" height="7"/></svg>
          </span>
          <span class="nav-item__label">Dashboard</span>
        </a>
        <a href="/reportes" class={`nav-item ${path.startsWith('/reportes') ? 'is-active' : ''}`} title="Reportes" data-tip="Reportes">
          <span class="nav-item__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h13l5 5v11a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/><path d="M17 4v5h5"/></svg>
          </span>
          <span class="nav-item__label">Reportes</span>
        </a>
        <a href="/calendario" class={`nav-item ${path.startsWith('/calendario') ? 'is-active' : ''}`} title="Calendario" data-tip="Calendario">
          <span class="nav-item__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          </span>
          <span class="nav-item__label">Calendario</span>
        </a>
        <a href="/entidades" class={`nav-item ${path.startsWith('/entidades') ? 'is-active' : ''}`} title="Entidades" data-tip="Entidades">
          <span class="nav-item__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22V8l9-5 9 5v14"/><path d="M9 22V12h6v10"/></svg>
          </span>
          <span class="nav-item__label">Entidades</span>
        </a>
        <a href="/usuarios" class={`nav-item ${path.startsWith('/usuarios') ? 'is-active' : ''}`} title="Usuarios" data-tip="Usuarios" id="nav-usuarios" style="display: none;">
          <span class="nav-item__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </span>
          <span class="nav-item__label">Usuarios</span>
        </a>
      </nav>

      <div id="sidebar-user" class="sidebar__user"></div>
    </aside>

    <div class="content">
      <header class="topbar">
        <div class="topbar__left">
          <button id="sidebar-toggle-sm" class="icon-btn show-on-mobile" aria-label="Abrir menú">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <h1 class="page-title">{title}</h1>
        </div>
        <div class="topbar__right">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="q" placeholder="Buscar..." aria-label="Buscar" />
          </div>
          <div id="user-inline"></div>
        </div>
      </header>

      <main class="page">
        <slot />
      </main>

      <footer class="footer">
        <div>© 2025 Tracely • Sistema de Gestión de Reportes Regulatorios</div>
      </footer>
    </div>
  </div>
</BaseLayout>

<script>
  import { authService } from '../lib/auth';

  // Persistir estado de colapso
  const STORAGE_KEY = 'tracely.sidebar.collapsed';

  function setCollapsed(collapsed: boolean) {
    const shell = document.querySelector('.app-shell');
    if (!shell) return;
    shell.classList.toggle('is-collapsed', !!collapsed);
    try { localStorage.setItem(STORAGE_KEY, collapsed ? '1' : '0'); } catch {}
    const toggle = document.getElementById('sidebar-toggle');
    if (toggle) toggle.setAttribute('aria-expanded', (!collapsed).toString());
    
  }

  if (typeof window !== 'undefined') {
    // Verificar autenticación
    const isAuth = authService.isAuthenticated();
    if (!isAuth) {
      window.location.href = '/login';
      throw new Error('Not authenticated'); // Detener ejecución
    }

    const user = authService.getUser();
    
    // Mostrar enlace de usuarios solo a administradores
    if (user && user.roles && (user.roles.includes('ROLE_ADMIN') || user.roles.includes('ROLE_ADMINISTRADOR'))) {
      const navUsuarios = document.getElementById('nav-usuarios');
      if (navUsuarios) navUsuarios.style.display = 'flex';
    }
    
    const userSlot = document.getElementById('sidebar-user');
    const userInline = document.getElementById('user-inline');
    // Construir nombre completo con los nuevos campos
    const name = user 
      ? `${user.firstName || ''} ${user.secondName || ''} ${user.firstLastname || ''} ${user.secondLastname || ''}`.trim().replace(/\s+/g, ' ')
      : '';

    const userMarkupSidebar = `
      <div class="userbox" id="userbox">
        <button class="userbox__avatar-btn" id="user-avatar-btn" aria-label="Abrir menú de usuario">
          <span class="userbox__avatar" aria-hidden="true">${name ? name.charAt(0).toUpperCase() : 'U'}</span>
        </button>
        <div class="userbox__menu" id="user-menu-pop" role="menu">
          <div class="userbox__name">${name}</div>
          <button class="btn btn-sm btn-secondary" data-logout="1" role="menuitem">Cerrar sesión</button>
        </div>
      </div>
    `;
    const userMarkupInline = `
      <div style="display:flex; align-items:center; gap:.5rem;">
        <span style="font-size:.9rem; color:var(--color-primary-900);">${name}</span>
        <button class="btn btn-sm btn-secondary" data-logout="1">Cerrar sesión</button>
      </div>
    `;
    if (userSlot) userSlot.innerHTML = userMarkupSidebar;
    if (userInline) userInline.innerHTML = userMarkupInline;

    document.querySelectorAll('[data-logout]')?.forEach((el) => {
      el.addEventListener('click', () => authService.logout());
    });

    // Restaurar estado de sidebar
    try { setCollapsed(localStorage.getItem(STORAGE_KEY) === '1'); } catch {}

    // Toggle handlers
    const toggleSidebar = () => {
      const collapsed = document.querySelector('.app-shell')?.classList.contains('is-collapsed');
      setCollapsed(!collapsed);
    };
    document.getElementById('sidebar-toggle')?.addEventListener('click', toggleSidebar);
    // Toggle menú de usuario
    document.getElementById('user-avatar-btn')?.addEventListener('click', (ev) => {
      ev.stopPropagation();
      const box = document.getElementById('userbox');
      box?.classList.toggle('is-open');
    });
    document.getElementById('sidebar-toggle-sm')?.addEventListener('click', () => {
      document.querySelector('.app-shell')?.classList.toggle('is-open-mobile');
    });
    // Cerrar al hacer clic fuera en mobile
    document.addEventListener('click', (e: MouseEvent) => {
      const shell = document.querySelector('.app-shell');
      if (!shell?.classList.contains('is-open-mobile')) return;
      const sidebar = document.querySelector('.sidebar');
      const target = e.target as HTMLElement | null;
      if (sidebar && target && !sidebar.contains(target) && !(target.closest && target.closest('#sidebar-toggle-sm'))) {
        shell.classList.remove('is-open-mobile');
      }
    });

    // Cerrar menú de usuario al hacer clic fuera
    document.addEventListener('click', (e: MouseEvent) => {
      const target = e.target as HTMLElement | null;
      const box = document.getElementById('userbox');
      if (box && !box.contains(target as Node)) {
        box.classList.remove('is-open');
      }
    });
  }
</script>

<style is:global>
  .app-shell { display: grid; grid-template-columns: auto 1fr; min-height: 100vh; }
  .app-shell .page { padding: 1.5rem 2rem; max-width: 1360px; margin: 0 auto; width: 100%; }

  /* Sidebar NEUTRO - fondo gris claro */
  .sidebar { 
    position: sticky; 
    top: 0; 
    height: 100vh; 
    width: 240px; 
    display: flex; 
    flex-direction: column; 
    background: #f1f5f9;
    color: var(--neutral-700); 
    border-right: 1px solid var(--neutral-200); 
    z-index: 30; 
    transition: width .34s cubic-bezier(.22,.61,.36,1); 
  }
  .app-shell.is-collapsed .sidebar { width: 72px; }
  .sidebar__header { 
    display: flex; 
    align-items: center; 
    justify-content: flex-end; 
    gap: .5rem; 
    padding: 1rem; 
    border-bottom: 1px solid var(--neutral-200); 
  }
  .icon-btn { 
    background: white; 
    color: var(--neutral-600); 
    border: 1px solid var(--neutral-300); 
    border-radius: 8px; 
    padding: .4rem; 
    display: grid; 
    place-items: center; 
    transition: all .2s ease;
    box-shadow: var(--shadow-sm);
  }
  .icon-btn:hover { 
    background: var(--neutral-100); 
    border-color: var(--neutral-400);
  }
  .icon-btn--bubble { 
    width: 32px; 
    height: 32px; 
    border-radius: 8px; 
    background: white;
    border: 1px solid var(--neutral-300);
    box-shadow: var(--shadow-sm);
  }
  .icon-btn--bubble:hover { 
    background: var(--neutral-100);
  }
  #sidebar-toggle svg { transition: transform .34s cubic-bezier(.22,.61,.36,1); color: var(--neutral-600); }
  .app-shell.is-collapsed #sidebar-toggle svg { transform: rotate(180deg); }

  /* Nav items con hover y activo sutiles */
  .sidebar__nav { display: grid; padding: 1rem .75rem; gap: .5rem; }
  .nav-item { 
    position: relative; 
    display: grid; 
    grid-template-columns: 20px 1fr; 
    align-items: center; 
    gap: .75rem; 
    color: var(--neutral-600); 
    height: 44px; 
    padding: 0 .75rem; 
    border-radius: 8px; 
    text-decoration: none; 
    transition: all .2s ease; 
    font-weight: 500;
    font-size: 0.9rem;
    letter-spacing: 0.2px;
  }
  .nav-item:hover { 
    background: rgba(60,120,230,0.08);
    color: var(--color-primary-700);
  }
  .nav-item.is-active { 
    background: rgba(60,120,230,0.15);
    color: var(--color-primary-700); 
    font-weight: 600;
  }
  .nav-item.is-active::before { 
    content: ""; 
    position: absolute; 
    left: 0; 
    top: 50%; 
    transform: translateY(-50%); 
    width: 4px; 
    height: 24px; 
    border-radius: 0 3px 3px 0; 
    background: var(--color-primary-600); 
  }
  .nav-item__icon { width: 20px; height: 20px; display: grid; place-items: center; color: var(--color-primary-700); opacity: 0.6; }
  .nav-item:hover .nav-item__icon,
  .nav-item.is-active .nav-item__icon { opacity: 1; }
  .nav-item__label { white-space: nowrap; transition: opacity .2s ease; }
  .app-shell.is-collapsed .nav-item { grid-template-columns: 20px; justify-items: center; padding: 0 .5rem; }
  .app-shell.is-collapsed .nav-item__label { opacity: 0; position: absolute; pointer-events: none; }

  /* Tooltip cuando está colapsado */
  .app-shell.is-collapsed .nav-item[data-tip]::after { content: attr(data-tip); position: absolute; left: calc(100% + 8px); top: 50%; transform: translateY(-50%); background: white; color: var(--neutral-800); border: 1px solid var(--neutral-200); border-radius: 6px; padding: .35rem .6rem; font-size: .8125rem; box-shadow: var(--shadow-card); opacity: 0; pointer-events: none; white-space: nowrap; transition: opacity .18s ease; z-index: 50; }
  .app-shell.is-collapsed .nav-item[data-tip]:hover::after { opacity: 1; }

  .sidebar__user { margin-top: auto; padding: .75rem; border-top: 1px solid var(--neutral-200); }
  .userbox { position: relative; display: grid; grid-template-columns: 36px 1fr; gap: .6rem; align-items: center; }
  .userbox__avatar-btn { all: unset; cursor: pointer; }
  .userbox__avatar { width: 36px; height: 36px; border-radius: 8px; background: var(--color-primary-600); color: white; display: grid; place-items: center; font-weight: 700; font-size: 0.875rem; }
  .userbox__menu { position: absolute; bottom: 52px; left: 10px; display: grid; gap: .5rem; background: white; color: var(--neutral-800); border: 1px solid var(--neutral-200); border-radius: 8px; padding: .75rem; box-shadow: var(--shadow-card); opacity: 0; transform: translateY(4px); pointer-events: none; transition: all .18s ease; min-width: 160px; z-index: 50; }
  .userbox.is-open .userbox__menu { opacity: 1; transform: translateY(0); pointer-events: auto; }
  .userbox__name { font-size: .875rem; font-weight: 600; color: var(--neutral-800); }

  /* Topbar BLANCO con borde gris */
  .content { display: grid; grid-template-rows: auto 1fr auto; background: #f8fafc; }
  .topbar { 
    position: sticky; 
    top: 0; 
    z-index: 20; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    gap: 1rem; 
    padding: 0.75rem 1.5rem; 
    height: 56px;
    background: white; 
    border-bottom: 1px solid var(--neutral-200);
  }
  .topbar .page-title { font-size: 1.125rem; font-weight: 700; color: var(--neutral-800); letter-spacing: 0.2px; }
  .topbar__left { display: flex; align-items: center; gap: .5rem; }
  .topbar__right { display: flex; align-items: center; gap: 1rem; }
  .search { 
    display: inline-flex; 
    align-items: center; 
    gap: .5rem; 
    padding: .5rem .75rem; 
    border: 1px solid var(--neutral-300); 
    border-radius: 8px; 
    background: #f8fafc; 
    transition: all 0.2s ease; 
  }
  .search:focus-within { 
    border-color: var(--color-primary-500); 
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
    background: white;
  }
  .search svg { color: var(--neutral-400); }
  .search input { border: 0; outline: none; font-size: .875rem; min-width: 160px; color: var(--neutral-700); background: transparent; }

  .page { padding: 1.5rem 2rem; max-width: 1360px; margin: 0 auto; width: 100%; }
  .footer { padding: .75rem 1.5rem; color: var(--neutral-500); background: white; border-top: 1px solid var(--neutral-200); font-size: 0.8125rem; }

  /* Mobile */
  .show-on-mobile { display: none; }
  @media (max-width: 980px) {
    .app-shell { grid-template-columns: 1fr; }
    .sidebar { position: fixed; left: -260px; width: 240px; height: 100dvh; border-right: none; box-shadow: var(--shadow-card); }
    .app-shell.is-open-mobile .sidebar { left: 0; transition: left .28s ease; }
    .content { position: relative; }
    .show-on-mobile { display: inline-grid; }
    .page { padding: 1rem; }
  }
</style>
