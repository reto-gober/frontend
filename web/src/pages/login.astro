---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Autenticación">
  <div class="page-bg">
    <div class="bg-overlay"></div>
  </div>

  <div class="container-auth">
    <div id="auth" class="auth-shell">
      <!-- Login -->
      <div class="pane sign-in">
        <div class="card-box">
          <h2 class="card-title">Iniciar Sesión</h2>
          <div id="login-error"></div>
          <form id="loginForm" class="form" autocomplete="on">
            <label class="form-label" for="loginEmail">Correo electrónico</label
            >
            <input
              class="form-input"
              id="loginEmail"
              name="email"
              type="email"
              autocomplete="email"
              required
            />

            <label class="form-label" for="loginPassword">Contraseña</label>
            <input
              class="form-input"
              id="loginPassword"
              name="password"
              type="password"
              autocomplete="current-password"
              required
            />

            <button id="loginBtn" type="submit" class="btn btn-primary w-full"
              >Iniciar Sesión</button
            >
          </form>
        </div>
      </div>

      <!-- Registro -->
      <div class="pane sign-up">
        <div class="card-box">
          <h2 class="card-title">Crear cuenta</h2>
          <div id="register-error"></div>
          <form id="registerForm" class="form" autocomplete="on">
            <div class="grid-2-sm">
              <div>
                <label class="form-label" for="nombre">Nombre</label>
                <input
                  class="form-input"
                  id="nombre"
                  name="nombre"
                  type="text"
                  required
                />
              </div>
              <div>
                <label class="form-label" for="apellido">Apellido</label>
                <input
                  class="form-input"
                  id="apellido"
                  name="apellido"
                  type="text"
                  required
                />
              </div>
            </div>
            <label class="form-label" for="regEmail">Correo electrónico</label>
            <input
              class="form-input"
              id="regEmail"
              name="email"
              type="email"
              autocomplete="email"
              required
            />
            <label class="form-label" for="regPassword">Contraseña</label>
            <input
              class="form-input"
              id="regPassword"
              name="password"
              type="password"
              minlength="6"
              autocomplete="new-password"
              required
            />
            <button
              id="registerBtn"
              type="submit"
              class="btn btn-primary w-full">Registrarse</button
            >
          </form>
        </div>
      </div>

      <!-- Overlay con CTA -->
      <div class="overlay">
        <div class="overlay-panel overlay-left">
          <h3 class="overlay-title">Bienvenido de nuevo</h3>
          <p class="overlay-text">¿Ya tienes cuenta? Inicia sesión aquí.</p>
          <button id="goSignIn" class="ghost">Iniciar sesión</button>
        </div>
        <div class="overlay-panel overlay-right">
          <h3 class="overlay-title">Bienvenido a Tracely</h3>
          <p class="overlay-text">Si aún no tienes cuenta, regístrate aquí.</p>
          <button id="goSignUp" class="ghost">Registrarse</button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { authService } from "../lib/auth";

  const wrapper = document.getElementById("auth");
  const goSignIn = document.getElementById("goSignIn");
  const goSignUp = document.getElementById("goSignUp");

  const loginForm = document.getElementById("loginForm") as HTMLFormElement;
  const loginError = document.getElementById("login-error");
  const loginBtn = document.getElementById("loginBtn") as HTMLButtonElement;

  const registerForm = document.getElementById(
    "registerForm",
  ) as HTMLFormElement;
  const registerError = document.getElementById("register-error");
  const registerBtn = document.getElementById(
    "registerBtn",
  ) as HTMLButtonElement;

  // Redirección si ya está autenticado
  if (authService.isAuthenticated()) {
    window.location.href = "/dashboard";
  }

  // Estado inicial por query param
  if (new URLSearchParams(window.location.search).get("mode") === "register") {
    wrapper?.classList.add("right-panel-active");
  }

  goSignUp?.addEventListener("click", () =>
    wrapper?.classList.add("right-panel-active"),
  );
  goSignIn?.addEventListener("click", () =>
    wrapper?.classList.remove("right-panel-active"),
  );

  // Login
  loginForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (loginError) loginError.innerHTML = "";
    loginBtn.disabled = true;
    loginBtn.textContent = "Iniciando sesión...";
    const data = new FormData(loginForm);
    try {
      const response = await authService.login({
        email: data.get("email") as string,
        password: data.get("password") as string,
      });
      authService.saveToken(response);
      window.location.href = "/dashboard";
    } catch (error: any) {
      const message =
        error.response?.data?.mensaje ||
        "Error al iniciar sesión. Verifica tus credenciales.";
      if (loginError)
        loginError.innerHTML = `<div class="alert alert-error">${message}</div>`;
      loginBtn.disabled = false;
      loginBtn.textContent = "Iniciar Sesión";
    }
  });

  // Registro
  registerForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (registerError) registerError.innerHTML = "";
    registerBtn.disabled = true;
    registerBtn.textContent = "Registrando...";
    const fd = new FormData(registerForm);
    try {
      await authService.register({
        documentType: fd.get("documentType") as string,
        documentNumber: fd.get("documentNumber") as string,
        birthDate: fd.get("birthDate") as string,
        roles: fd.getAll("roles") as string[],
        firstName: fd.get("firstName") as string,
        lastName: fd.get("lastName") as string,
        middleName: fd.get("middleName") as string,
        secondLastName: fd.get("secondLastName") as string,
        email: fd.get("email") as string,
        password: fd.get("password") as string,
      });
      if (registerError)
        registerError.innerHTML = `<div class="alert alert-success">Registro exitoso. Ahora puedes iniciar sesión.</div>`;
      registerBtn.disabled = false;
      registerBtn.textContent = "Registrarse";
      wrapper?.classList.remove("right-panel-active");
    } catch (error: any) {
      const message =
        error.response?.data?.mensaje ||
        "Error al registrarse. Intenta nuevamente.";
      if (registerError)
        registerError.innerHTML = `<div class="alert alert-error">${message}</div>`;
      registerBtn.disabled = false;
      registerBtn.textContent = "Registrarse";  
    }
  });
</script>

<style>
  /* Fondo dinámico */
  .page-bg {
    position: fixed;
    inset: 0;
    background: linear-gradient(
      135deg,
      var(--color-primary-900),
      var(--color-primary-700)
    );
    z-index: -2;
    overflow: hidden;
  }
  .bg-overlay {
    position: absolute;
    inset: 0;
    background: radial-gradient(
        900px 380px at 15% 85%,
        rgba(255, 80, 80, 0.12),
        transparent 60%
      ),
      radial-gradient(
        800px 320px at 85% 20%,
        rgba(61, 133, 209, 0.2),
        transparent 60%
      );
  }
  .page-bg::before,
  .page-bg::after {
    content: "";
    position: absolute;
    width: 60vmin;
    height: 60vmin;
    border-radius: 50%;
    filter: blur(40px);
    opacity: 0.25;
    mix-blend-mode: screen;
    background: radial-gradient(circle at 30% 30%, #6ea8ff, transparent 60%);
    animation: float 12s ease-in-out infinite;
  }
  .page-bg::after {
    right: -10vmin;
    top: -10vmin;
    background: radial-gradient(circle at 70% 70%, #ff5599, transparent 60%);
    animation-duration: 16s;
  }
  @keyframes float {
    0%,
    100% {
      transform: translateY(0) translateX(0);
    }
    50% {
      transform: translateY(-20px) translateX(10px);
    }
  }

  .container-auth {
    min-height: 100vh;
    display: grid;
    place-items: center;
    padding: 2rem 1rem;
  }

  /* Shell base con efecto de “caja que se mueve” */
  .auth-shell {
    position: relative;
    width: min(1100px, 96vw);
    height: 580px;
    perspective: 1200px;
  }
  .pane {
    position: absolute;
    top: 0;
    width: 50%;
    height: 100%;
    display: grid;
    place-items: center;
    transition:
      transform 0.6s ease,
      opacity 0.6s ease;
  }
  .sign-in {
    left: 0;
    z-index: 2;
  }
  .sign-up {
    left: 0;
    transform: translateX(100%);
    opacity: 0;
    z-index: 1;
  }

  /* Tarjetas internas para que se vean separadas del resto */
  .card-box {
    width: 86%;
    max-width: 480px;
    background: linear-gradient(
        180deg,
        rgba(255, 255, 255, 0.98),
        rgba(245, 250, 255, 0.9)
      ),
      radial-gradient(
        120% 100% at 10% 0%,
        rgba(116, 187, 230, 0.2),
        transparent 50%
      );
    border: 1px solid rgba(199, 228, 246, 0.8);
    border-radius: 18px;
    padding: 2.25rem;
    box-shadow:
      0 30px 80px rgba(0, 0, 0, 0.28),
      inset 0 1px 0 rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(8px) saturate(120%);
    transition:
      transform 0.35s ease,
      box-shadow 0.35s ease;
  }
  .card-box:hover {
    transform: translateY(-2px);
    box-shadow:
      0 38px 90px rgba(0, 0, 0, 0.32),
      inset 0 1px 0 rgba(255, 255, 255, 0.65);
  }
  .card-title {
    text-align: center;
    color: var(--color-primary-900);
    margin-bottom: 1.25rem;
    font-size: 1.75rem;
    letter-spacing: 0.3px;
  }

  .form {
    display: grid;
    gap: 0.75rem;
  }
  .form-label {
    font-weight: 600;
    font-size: 0.9rem;
  }
  .form-input {
    width: 100%;
    padding: 0.7rem 0.85rem;
    border: 1px solid var(--color-border);
    border-radius: 10px;
    font-size: 0.98rem;
    background: #fff;
    transition:
      border-color 0.2s ease,
      box-shadow 0.2s ease,
      transform 0.2s ease;
  }
  .form-input:hover {
    box-shadow: 0 1px 0 rgba(31, 49, 76, 0.04);
  }
  .form-input:focus {
    outline: none;
    border-color: var(--color-primary-600);
    box-shadow: 0 0 0 4px rgba(61, 133, 209, 0.16);
    transform: translateY(-1px);
  }
  .w-full {
    width: 100%;
  }

  /* Overlay que se mueve y sirve de CTA */
  .overlay {
    position: absolute;
    left: 50%;
    width: 50%;
    height: 100%;
    overflow: hidden;
    transition: transform 0.6s ease;
    z-index: 100;
    color: #fff;
    background: transparent;
    border: 0;
    backdrop-filter: none;
    border-radius: 0;
  }
  .overlay::after {
    display: none;
  }
  .overlay-panel {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: grid;
    gap: 0.75rem;
    text-align: center;
    padding: 0 2rem;
    width: 50%;
  }
  .overlay-left {
    right: 50%;
  }
  .overlay-right {
    right: 0;
  }
  .overlay-title {
    font-size: 1.7rem;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
  }
  .overlay-text {
    opacity: 0.92;
  }
  .ghost {
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.7);
    padding: 0.65rem 1.25rem;
    border-radius: 10px;
    transition:
      transform 0.2s ease,
      background 0.2s ease,
      box-shadow 0.2s ease;
  }
  .ghost:hover {
    background: rgba(255, 255, 255, 0.16);
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
  }

  /* Mostrar un solo botón según el estado */
  .overlay-panel {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
  }
  /* Estado inicial (login visible) -> mostrar botón Registrarse */
  .overlay-right {
    opacity: 1;
    pointer-events: auto;
  }
  /* Estado registro activo -> mostrar botón Iniciar sesión */
  .auth-shell.right-panel-active .overlay-right {
    opacity: 0;
    pointer-events: none;
  }
  .auth-shell.right-panel-active .overlay-left {
    opacity: 1;
    pointer-events: auto;
  }

  /* Estado activo: desplazar panes y overlay */
  .auth-shell.right-panel-active .sign-in {
    transform: translateX(-100%);
    opacity: 0;
  }
  .auth-shell.right-panel-active .sign-up {
    transform: translateX(100%);
    opacity: 1;
    z-index: 5;
  }
  .auth-shell.right-panel-active .overlay {
    transform: translateX(-100%);
  }

  /* Animación 3D sutil en tarjetas durante el cambio */
  .auth-shell.right-panel-active .sign-in .card-box {
    transform: translateX(-8%) scale(0.96) rotateY(-6deg);
    opacity: 0.92;
  }
  .auth-shell.right-panel-active .sign-up .card-box {
    transform: translateX(0) scale(1.02);
  }

  /* Mobile: apilar y ocultar overlay */
  @media (max-width: 900px) {
    .auth-shell {
      height: auto;
    }
    .pane {
      position: relative;
      width: 100%;
      transform: none !important;
      opacity: 1 !important;
    }
    .overlay {
      display: none;
    }
    .card-box {
      width: 100%;
      margin-bottom: 1rem;
    }
  }

  .grid-2-sm {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }
  @media (max-width: 520px) {
    .grid-2-sm {
      grid-template-columns: 1fr;
    }
  }
</style>
